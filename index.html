<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Legale - Gestione Pratiche</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px);} to {opacity:1;transform:translateY(0);}}
        .animate-fadein { animation: fadeIn 0.3s; }
    </style>
</head>
<body>
<div id="app" class="min-h-screen bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 flex items-center justify-center">
    <div class="text-white text-center">
        <div class="text-6xl mb-4">âš–ï¸</div>
        <p class="text-xl">Caricamento...</p>
    </div>
</div>

<script>
// â”€â”€â”€ SUPABASE CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SUPABASE_URL = 'https://vwfubfydakocuxhepwkq.supabase.co';
const SUPABASE_KEY = 'sb_publishable_ziNieyV1K_9bPBNJu6GHUQ_j2kVEyn2';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let state = {
    activeTab: 'dashboard',
    pratiche: [],
    avvocati: [],
    searchTerm: '',
    filterStato: 'tutti',
    showModal: false,
    showAvvocatoModal: false,
    editingPratica: null,
    editingAvvocato: null,
    successMessage: '',
    loading: false,
    formData: { cliente:'', tipo_pratica:'civile', descrizione:'', stato:'aperta',
        data_apertura: today(), data_udienza:'', avvocato:'', note:'' },
    avvForm: { nome:'', cognome:'', email:'', telefono:'', specializzazione:'civile' }
};

function today() { return new Date().toISOString().split('T')[0]; }

// â”€â”€â”€ SUPABASE OPERATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPratiche() {
    const { data, error } = await sb.from('pratiche').select('*').order('numero', { ascending: false });
    if (!error) state.pratiche = data || [];
}

async function loadAvvocati() {
    const { data, error } = await sb.from('avvocati').select('*').order('cognome');
    if (!error) state.avvocati = data || [];
}

async function savePratica(pratica) {
    try {
        if (pratica.id) {
            const { error } = await sb.from('pratiche').update(pratica).eq('id', pratica.id);
            if (error) throw error;
        } else {
            pratica.numero = Date.now();
            pratica.data_modifica = today();
            const { error } = await sb.from('pratiche').insert([pratica]);
            if (error) throw error;
        }
        await loadPratiche();
        return true;
    } catch(e) { alert('Errore: ' + e.message); return false; }
}

async function deletePratica(id) {
    const { error } = await sb.from('pratiche').delete().eq('id', id);
    if (!error) { await loadPratiche(); showSuccess('Pratica eliminata!'); }
    else alert('Errore eliminazione: ' + error.message);
}

async function saveAvvocato(avv) {
    try {
        avv.nome_completo = avv.nome + ' ' + avv.cognome;
        if (avv.id) {
            const { error } = await sb.from('avvocati').update(avv).eq('id', avv.id);
            if (error) throw error;
        } else {
            avv.data_creazione = today();
            const { error } = await sb.from('avvocati').insert([avv]);
            if (error) throw error;
        }
        await loadAvvocati();
        return true;
    } catch(e) { alert('Errore: ' + e.message); return false; }
}

async function deleteAvvocato(id) {
    const nome = state.avvocati.find(a => a.id === id)?.nome_completo;
    if (state.pratiche.filter(p => p.avvocato === nome).length > 0) {
        alert('Impossibile eliminare: ci sono pratiche assegnate a questo avvocato!');
        return;
    }
    const { error } = await sb.from('avvocati').delete().eq('id', id);
    if (!error) { await loadAvvocati(); showSuccess('Avvocato eliminato!'); }
    else alert('Errore: ' + error.message);
}

// â”€â”€â”€ EXPORT / IMPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esportaDati() {
    const data = { pratiche: state.pratiche, avvocati: state.avvocati,
        dataEsportazione: new Date().toISOString(), versione: '2.0' };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `studio-legale-backup-${today()}.json`;
    document.body.appendChild(a); a.click();
    document.body.removeChild(a); URL.revokeObjectURL(url);
    showSuccess('Dati esportati!');
}

function importaDati(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (ev) => {
        try {
            const data = JSON.parse(ev.target.result);
            if (!data.pratiche || !data.avvocati) { alert('File non valido'); return; }
            if (!confirm(`Importare ${data.pratiche.length} pratiche e ${data.avvocati.length} avvocati?\nQuesto aggiungerÃ  i dati al database.`)) return;
            for (const a of data.avvocati) {
                delete a.id; delete a.created_at;
                await sb.from('avvocati').insert([a]);
            }
            for (const p of data.pratiche) {
                delete p.id; delete p.created_at;
                await sb.from('pratiche').insert([p]);
            }
            await loadPratiche(); await loadAvvocati();
            showSuccess(`Importati ${data.pratiche.length} pratiche e ${data.avvocati.length} avvocati!`);
        } catch(er) { alert('Errore importazione: ' + er.message); }
    };
    reader.readAsText(file);
    e.target.value = '';
}

// â”€â”€â”€ UI HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showSuccess(msg) {
    state.successMessage = msg;
    render();
    setTimeout(() => { state.successMessage = ''; render(); }, 3000);
}

function getStatoBadge(s) {
    return { aperta:'bg-green-100 text-green-800', 'in-corso':'bg-yellow-100 text-yellow-800',
        chiusa:'bg-blue-100 text-blue-800' }[s] || 'bg-green-100 text-green-800';
}

function getStatoIcon(s) {
    if (s === 'chiusa') return 'âœ…';
    if (s === 'in-corso') return 'ğŸ•';
    return 'ğŸ””';
}

function getAvvStats(nome) {
    const ps = state.pratiche.filter(p => p.avvocato === nome);
    return { totali: ps.length, aperte: ps.filter(p=>p.stato==='aperta').length,
        inCorso: ps.filter(p=>p.stato==='in-corso').length, chiuse: ps.filter(p=>p.stato==='chiusa').length };
}

function getUdienze() {
    return state.pratiche.filter(p => p.data_udienza && new Date(p.data_udienza) >= new Date() && p.stato !== 'chiusa')
        .sort((a,b) => new Date(a.data_udienza) - new Date(b.data_udienza)).slice(0,5);
}

function getFiltered() {
    return state.pratiche.filter(p => {
        const s = state.searchTerm.toLowerCase();
        const match = p.cliente.toLowerCase().includes(s) || 
            (p.numero||'').toString().includes(s) || p.descrizione.toLowerCase().includes(s);
        const filt = state.filterStato === 'tutti' || p.stato === state.filterStato;
        return match && filt;
    });
}

function fmtDate(d) { return d ? new Date(d).toLocaleDateString('it-IT') : ''; }
function fmtDay(d) { return d ? new Date(d).toLocaleDateString('it-IT', {weekday:'long'}) : ''; }

// â”€â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
    const stats = { totali: state.pratiche.length,
        aperte: state.pratiche.filter(p=>p.stato==='aperta').length,
        inCorso: state.pratiche.filter(p=>p.stato==='in-corso').length,
        chiuse: state.pratiche.filter(p=>p.stato==='chiusa').length };
    const udienze = getUdienze();
    const filtered = getFiltered();

    document.getElementById('app').innerHTML = `
    <div class="max-w-7xl mx-auto p-4 w-full">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-2xl mb-6 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-900 to-indigo-800 text-white p-8">
                <h1 class="text-4xl font-bold mb-2">âš–ï¸ Studio Legale</h1>
                <p class="text-blue-200">Sistema di Gestione Pratiche</p>
                <div class="mt-4 bg-white/10 rounded-full px-4 py-2 inline-flex items-center gap-2">
                    <span class="text-sm">ğŸ‘¥ ${state.avvocati.length} Avvocati</span>
                    <span class="text-white/50">|</span>
                    <span class="text-sm">ğŸ“ ${state.pratiche.length} Pratiche</span>
                    <span class="text-white/50">|</span>
                    <span class="text-sm text-green-300">ğŸŸ¢ Supabase</span>
                </div>
            </div>
            <div class="flex bg-gray-50 border-b overflow-x-auto">
                ${[
                    {id:'dashboard', label:'Dashboard', icon:'ğŸ“Š'},
                    {id:'pratiche', label:'Pratiche', icon:'ğŸ“'},
                    {id:'avvocati', label:'Avvocati', icon:'ğŸ‘¥'},
                    {id:'calendario', label:'Calendario', icon:'ğŸ“…'},
                    {id:'gestione', label:'Gestione Dati', icon:'ğŸ—„ï¸'}
                ].map(t => `
                    <button onclick="switchTab('${t.id}')" class="flex items-center gap-2 px-6 py-4 font-semibold transition-all whitespace-nowrap
                        ${state.activeTab===t.id ? 'bg-white text-indigo-600 border-b-4 border-indigo-600' : 'text-gray-600 hover:bg-gray-100'}">
                        ${t.icon} ${t.label}
                    </button>
                `).join('')}
            </div>
        </div>

        ${state.successMessage ? `
        <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-lg mb-6 shadow-lg">
            <p class="font-semibold">âœ… ${state.successMessage}</p>
        </div>` : ''}

        <!-- DASHBOARD -->
        ${state.activeTab === 'dashboard' ? `
        <div class="space-y-6">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                ${[
                    {label:'Totale Pratiche', val:stats.totali, icon:'ğŸ“', color:'indigo'},
                    {label:'Aperte', val:stats.aperte, icon:'ğŸ””', color:'green'},
                    {label:'In Corso', val:stats.inCorso, icon:'ğŸ•', color:'yellow'},
                    {label:'Chiuse', val:stats.chiuse, icon:'âœ…', color:'blue'}
                ].map(s => `
                    <div class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">${s.label}</p>
                                <p class="text-3xl font-bold text-${s.color}-600">${s.val}</p>
                            </div>
                            <span class="text-4xl">${s.icon}</span>
                        </div>
                    </div>
                `).join('')}
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">ğŸ“… Prossime Udienze</h2>
                ${udienze.length > 0 ? udienze.map(p => `
                    <div class="flex items-center justify-between p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg border-l-4 border-indigo-500 mb-3">
                        <div>
                            <p class="font-semibold text-gray-800">${p.cliente}</p>
                            <p class="text-sm text-gray-600">${p.descrizione}</p>
                            <p class="text-xs text-gray-500 mt-1">ğŸ‘¤ ${p.avvocato}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-indigo-600">${fmtDate(p.data_udienza)}</p>
                            <p class="text-xs text-gray-500">#${p.numero}</p>
                        </div>
                    </div>
                `).join('') : '<p class="text-gray-400 text-center py-8">Nessuna udienza programmata</p>'}
            </div>
        </div>` : ''}

        <!-- PRATICHE -->
        ${state.activeTab === 'pratiche' ? `
        <div class="space-y-6">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1 relative">
                        <span class="absolute left-3 top-3 text-gray-400">ğŸ”</span>
                        <input type="text" placeholder="Cerca cliente, numero, descrizione..."
                            value="${state.searchTerm}"
                            oninput="state.searchTerm=this.value;render()"
                            class="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none"/>
                    </div>
                    <select onchange="state.filterStato=this.value;render()"
                        class="px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none">
                        <option value="tutti" ${state.filterStato==='tutti'?'selected':''}>Tutti gli stati</option>
                        <option value="aperta" ${state.filterStato==='aperta'?'selected':''}>Aperte</option>
                        <option value="in-corso" ${state.filterStato==='in-corso'?'selected':''}>In Corso</option>
                        <option value="chiusa" ${state.filterStato==='chiusa'?'selected':''}>Chiuse</option>
                    </select>
                    <button onclick="openPraticaModal(null)"
                        class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg font-semibold hover:shadow-lg transition-all">
                        â• Nuova Pratica
                    </button>
                </div>
            </div>
            <div class="space-y-4">
                ${filtered.length > 0 ? filtered.map(p => `
                    <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-all">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-3 flex-wrap">
                                    <span class="text-2xl font-bold text-indigo-600">#${p.numero}</span>
                                    <span class="px-3 py-1 rounded-full text-xs font-semibold ${getStatoBadge(p.stato)}">
                                        ${getStatoIcon(p.stato)} ${p.stato.toUpperCase()}
                                    </span>
                                    <span class="px-3 py-1 bg-gray-100 rounded-full text-xs font-semibold">${p.tipo_pratica}</span>
                                </div>
                                <h3 class="text-xl font-bold text-gray-800 mb-2">${p.cliente}</h3>
                                <p class="text-gray-600 mb-2">${p.descrizione}</p>
                                <div class="flex flex-wrap gap-4 text-sm text-gray-500">
                                    <span>ğŸ‘¤ ${p.avvocato}</span>
                                    <span>ğŸ“… ${fmtDate(p.data_apertura)}</span>
                                    ${p.data_udienza ? `<span>âš–ï¸ Udienza: ${fmtDate(p.data_udienza)}</span>` : ''}
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="openPraticaModal(${JSON.stringify(p).replace(/"/g,'&quot;')})"
                                    class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">âœï¸ Modifica</button>
                                <button onclick="confirmDeletePratica('${p.id}')"
                                    class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">ğŸ—‘ï¸ Elimina</button>
                            </div>
                        </div>
                        ${p.note ? `<div class="mt-4 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                            <p class="text-sm text-gray-700"><strong>Note:</strong> ${p.note}</p>
                        </div>` : ''}
                    </div>
                `).join('') : `
                    <div class="bg-white rounded-xl shadow-lg p-12 text-center">
                        <div class="text-6xl mb-4">ğŸ“</div>
                        <p class="text-gray-400 text-lg">Nessuna pratica trovata</p>
                    </div>`}
            </div>
        </div>` : ''}

        <!-- AVVOCATI -->
        ${state.activeTab === 'avvocati' ? `
        <div class="space-y-6">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">ğŸ‘¥ Archivio Avvocati</h2>
                    <button onclick="openAvvocatoModal(null)"
                        class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg font-semibold hover:shadow-lg transition-all">
                        â• Nuovo Avvocato
                    </button>
                </div>
                ${state.avvocati.length > 0 ? `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${state.avvocati.map(a => {
                        const st = getAvvStats(a.nome_completo);
                        return `
                        <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl p-6 border-2 border-indigo-100">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800">${a.nome_completo}</h3>
                                    <p class="text-sm text-indigo-600 font-semibold">${a.specializzazione}</p>
                                </div>
                                <span class="text-3xl">ğŸ’¼</span>
                            </div>
                            <div class="space-y-2 mb-4">
                                <p class="text-sm text-gray-600">ğŸ“§ ${a.email}</p>
                                <p class="text-sm text-gray-600">ğŸ“± ${a.telefono}</p>
                            </div>
                            <div class="bg-white rounded-lg p-3 mb-4">
                                <p class="text-xs text-gray-500 mb-2">Pratiche assegnate:</p>
                                <div class="grid grid-cols-4 gap-2 text-center">
                                    <div><p class="text-lg font-bold text-gray-800">${st.totali}</p><p class="text-xs text-gray-500">Totali</p></div>
                                    <div><p class="text-lg font-bold text-green-600">${st.aperte}</p><p class="text-xs text-gray-500">Aperte</p></div>
                                    <div><p class="text-lg font-bold text-yellow-600">${st.inCorso}</p><p class="text-xs text-gray-500">In Corso</p></div>
                                    <div><p class="text-lg font-bold text-blue-600">${st.chiuse}</p><p class="text-xs text-gray-500">Chiuse</p></div>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="openAvvocatoModal(${JSON.stringify(a).replace(/"/g,'&quot;')})"
                                    class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">âœï¸ Modifica</button>
                                <button onclick="confirmDeleteAvvocato('${a.id}')"
                                    class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">ğŸ—‘ï¸ Elimina</button>
                            </div>
                        </div>`;
                    }).join('')}
                </div>` : `
                <div class="text-center py-12">
                    <div class="text-6xl mb-4">ğŸ‘¥</div>
                    <p class="text-gray-400 text-lg">Nessun avvocato in archivio</p>
                    <p class="text-gray-400 text-sm mt-2">Aggiungi il primo avvocato per iniziare</p>
                </div>`}
            </div>
        </div>` : ''}

        <!-- CALENDARIO -->
        ${state.activeTab === 'calendario' ? `
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">ğŸ“… Calendario Udienze</h2>
            ${udienze.length > 0 ? udienze.map(p => `
                <div class="p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border-l-4 border-blue-500 mb-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">${p.cliente}</h3>
                            <p class="text-gray-600 mb-2">${p.descrizione}</p>
                            <p class="text-sm text-gray-500">Pratica #${p.numero}</p>
                            <p class="text-sm text-indigo-600 font-semibold mt-1">ğŸ‘¤ ${p.avvocato}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-blue-600">${fmtDate(p.data_udienza)}</p>
                            <p class="text-sm text-gray-500 mt-1">${fmtDay(p.data_udienza)}</p>
                        </div>
                    </div>
                </div>
            `).join('') : `
            <div class="text-center py-12">
                <div class="text-6xl mb-4">ğŸ“…</div>
                <p class="text-gray-400 text-lg">Nessuna udienza programmata</p>
            </div>`}
        </div>` : ''}

        <!-- GESTIONE DATI -->
        ${state.activeTab === 'gestione' ? `
        <div class="space-y-6">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">ğŸ—„ï¸ Gestione Database</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-6 border-2 border-green-200">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="text-4xl">ğŸ“¥</span>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Esporta Dati</h3>
                                <p class="text-sm text-gray-600">Backup completo su file</p>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg p-4 mb-4">
                            <p class="text-sm text-gray-700 mb-2">ğŸ“Š <strong>Pratiche:</strong> ${state.pratiche.length}</p>
                            <p class="text-sm text-gray-700">ğŸ‘¥ <strong>Avvocati:</strong> ${state.avvocati.length}</p>
                        </div>
                        <button onclick="esportaDati()"
                            class="w-full px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg font-semibold hover:shadow-lg transition-all">
                            ğŸ“¥ Esporta Database
                        </button>
                    </div>
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-6 border-2 border-blue-200">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="text-4xl">ğŸ“¤</span>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Importa Dati</h3>
                                <p class="text-sm text-gray-600">Ripristina da backup</p>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg p-4 mb-4">
                            <p class="text-sm text-gray-700 mb-2">âš ï¸ <strong>Attenzione:</strong></p>
                            <p class="text-xs text-gray-600">I dati importati verranno aggiunti al database Supabase.</p>
                        </div>
                        <label class="w-full px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg font-semibold hover:shadow-lg transition-all flex items-center justify-center gap-2 cursor-pointer">
                            ğŸ“¤ Seleziona File Backup
                            <input type="file" accept=".json" onchange="importaDati(event)" class="hidden"/>
                        </label>
                    </div>
                </div>
                <div class="mt-6 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-6 border-2 border-purple-200">
                    <h3 class="text-lg font-bold text-gray-800 mb-3">ğŸ—„ï¸ Informazioni Storage</h3>
                    <div class="space-y-2 text-sm text-gray-700">
                        <p>ğŸ“ <strong>Database:</strong> Supabase PostgreSQL (Cloud)</p>
                        <p>ğŸŒ <strong>Server:</strong> West EU - Ireland</p>
                        <p>ğŸ” <strong>Sicurezza:</strong> Dati protetti su server dedicato</p>
                        <p>ğŸ’¾ <strong>Persistenza:</strong> Dati accessibili da qualsiasi dispositivo</p>
                        <p>âš¡ <strong>Salvataggio:</strong> Automatico ad ogni operazione</p>
                        <p class="mt-4 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                            <strong>ğŸ’¡ Consiglio:</strong> Esporta regolarmente i tuoi dati per avere un backup locale di sicurezza!
                        </p>
                    </div>
                </div>
            </div>
        </div>` : ''}

        <!-- MODAL PRATICA -->
        ${state.showModal ? `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 flex justify-between items-center">
                    <h2 class="text-2xl font-bold">${state.editingPratica ? 'âœï¸ Modifica Pratica' : 'â• Nuova Pratica'}</h2>
                    <button onclick="state.showModal=false;render()" class="hover:bg-white/20 rounded-full p-2 text-2xl">âœ•</button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Cliente *</label>
                        <input type="text" value="${state.formData.cliente}" oninput="state.formData.cliente=this.value"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none" placeholder="Nome del cliente"/>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Tipo Pratica *</label>
                            <select onchange="state.formData.tipo_pratica=this.value"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none">
                                ${['civile','penale','amministrativo','lavoro','famiglia'].map(t => 
                                    `<option value="${t}" ${state.formData.tipo_pratica===t?'selected':''}>${t.charAt(0).toUpperCase()+t.slice(1)}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Stato *</label>
                            <select onchange="state.formData.stato=this.value"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none">
                                ${[['aperta','Aperta'],['in-corso','In Corso'],['chiusa','Chiusa']].map(([v,l]) => 
                                    `<option value="${v}" ${state.formData.stato===v?'selected':''}>${l}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Descrizione *</label>
                        <textarea oninput="state.formData.descrizione=this.value" rows="3"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none"
                            placeholder="Descrizione della pratica">${state.formData.descrizione}</textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Data Apertura *</label>
                            <input type="date" value="${state.formData.data_apertura}" oninput="state.formData.data_apertura=this.value"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none"/>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Data Udienza</label>
                            <input type="date" value="${state.formData.data_udienza||''}" oninput="state.formData.data_udienza=this.value"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none"/>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Avvocato Responsabile *</label>
                        <select onchange="state.formData.avvocato=this.value"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none">
                            <option value="">-- Seleziona un avvocato --</option>
                            ${state.avvocati.map(a => 
                                `<option value="${a.nome_completo}" ${state.formData.avvocato===a.nome_completo?'selected':''}>${a.nome_completo} (${a.specializzazione})</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Note</label>
                        <textarea oninput="state.formData.note=this.value" rows="3"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none"
                            placeholder="Note aggiuntive...">${state.formData.note||''}</textarea>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button onclick="submitPratica()"
                            class="flex-1 px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg font-semibold hover:shadow-lg transition-all">
                            ğŸ’¾ ${state.editingPratica ? 'Aggiorna' : 'Salva Pratica'}
                        </button>
                        <button onclick="state.showModal=false;render()"
                            class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">Annulla</button>
                    </div>
                </div>
            </div>
        </div>` : ''}

        <!-- MODAL AVVOCATO -->
        ${state.showAvvocatoModal ? `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-2xl shadow-2xl max-w-xl w-full max-h-[90vh] overflow-y-auto">
                <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 flex justify-between items-center">
                    <h2 class="text-2xl font-bold">${state.editingAvvocato ? 'âœï¸ Modifica Avvocato' : 'â• Nuovo Avvocato'}</h2>
                    <button onclick="state.showAvvocatoModal=false;render()" class="hover:bg-white/20 rounded-full p-2 text-2xl">âœ•</button>
                </div>
                <div class="p-6 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Nome *</label>
                            <input type="text" value="${state.avvForm.nome}" oninput="state.avvForm.nome=this.value"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none" placeholder="Nome"/>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Cognome *</label>
                            <input type="text" value="${state.avvForm.cognome}" oninput="state.avvForm.cognome=this.value"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none" placeholder="Cognome"/>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Email *</label>
                        <input type="email" value="${state.avvForm.email}" oninput="state.avvForm.email=this.value"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none" placeholder="email@esempio.it"/>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Telefono *</label>
                        <input type="tel" value="${state.avvForm.telefono}" oninput="state.avvForm.telefono=this.value"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none" placeholder="+39 333 1234567"/>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Specializzazione *</label>
                        <select onchange="state.avvForm.specializzazione=this.value"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none">
                            ${['civile','penale','amministrativo','lavoro','famiglia'].map(s => 
                                `<option value="${s}" ${state.avvForm.specializzazione===s?'selected':''}>${s.charAt(0).toUpperCase()+s.slice(1)}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button onclick="submitAvvocato()"
                            class="flex-1 px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg font-semibold hover:shadow-lg transition-all">
                            ğŸ’¾ ${state.editingAvvocato ? 'Aggiorna' : 'Salva Avvocato'}
                        </button>
                        <button onclick="state.showAvvocatoModal=false;render()"
                            class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">Annulla</button>
                    </div>
                </div>
            </div>
        </div>` : ''}
    </div>`;
}

// â”€â”€â”€ HANDLERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) { state.activeTab = tab; render(); }

function openPraticaModal(p) {
    state.editingPratica = p;
    state.formData = p ? {...p} : { cliente:'', tipo_pratica:'civile', descrizione:'', stato:'aperta',
        data_apertura:today(), data_udienza:'', avvocato:'', note:'' };
    state.showModal = true;
    render();
}

function openAvvocatoModal(a) {
    state.editingAvvocato = a;
    state.avvForm = a ? { nome:a.nome, cognome:a.cognome, email:a.email, telefono:a.telefono, specializzazione:a.specializzazione }
        : { nome:'', cognome:'', email:'', telefono:'', specializzazione:'civile' };
    state.showAvvocatoModal = true;
    render();
}

async function submitPratica() {
    if (!state.formData.cliente || !state.formData.descrizione || !state.formData.avvocato) {
        alert('Compila tutti i campi obbligatori (*)'); return;
    }
    const pratica = { ...state.formData };
    if (state.editingPratica) pratica.id = state.editingPratica.id;
    pratica.data_modifica = today();
    const ok = await savePratica(pratica);
    if (ok) {
        state.showModal = false;
        state.editingPratica = null;
        showSuccess(state.editingPratica ? 'Pratica aggiornata!' : 'Pratica salvata su Supabase!');
        render();
    }
}

async function submitAvvocato() {
    if (!state.avvForm.nome || !state.avvForm.cognome || !state.avvForm.email || !state.avvForm.telefono) {
        alert('Compila tutti i campi obbligatori (*)'); return;
    }
    const avv = { ...state.avvForm };
    if (state.editingAvvocato) avv.id = state.editingAvvocato.id;
    const ok = await saveAvvocato(avv);
    if (ok) {
        state.showAvvocatoModal = false;
        state.editingAvvocato = null;
        showSuccess(state.editingAvvocato ? 'Avvocato aggiornato!' : 'Avvocato salvato su Supabase!');
        render();
    }
}

function confirmDeletePratica(id) {
    if (confirm('Sei sicuro di voler eliminare questa pratica?')) deletePratica(id);
}

function confirmDeleteAvvocato(id) {
    if (confirm('Sei sicuro di voler eliminare questo avvocato?')) deleteAvvocato(id);
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
    render();
    await Promise.all([loadPratiche(), loadAvvocati()]);
    render();
}

init();
</script>
</body>
</html>
