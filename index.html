<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLS Studio Legale - Gestione Pratiche</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.39.3/umd/supabase.min.js"></script>
    <style>
        @keyframes fadeIn { from {opacity:0;transform:translateY(10px);} to {opacity:1;transform:translateY(0);}}
        .animate-fadein { animation: fadeIn 0.3s; }
        @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:.5;} }
        .animate-pulse { animation: pulse 2s cubic-bezier(.4,0,.6,1) infinite; }
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
            .print-full { width: 100% !important; max-width: 100% !important; padding: 20px !important; }
        }
        .scaduta { background-color: #fee2e2 !important; border-left: 4px solid #dc2626 !important; }
        .priorita-bassa { background-color: #dbeafe; color: #1e40af; }
        .priorita-media { background-color: #3b82f6; color: white; }
        .priorita-alta { background-color: #1e3a8a; color: white; }
        .stato-svolgimento { background-color: #fef3c7; color: #92400e; }
        .stato-fatto { background-color: #d1fae5; color: #065f46; }
        .stato-bloccato { background-color: #fee2e2; color: #991b1b; }
        .bg-gradient-indigo { background: linear-gradient(135deg, #1e3a8a 0%, #4338ca 100%); }
        .bg-gradient-purple { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
        .bg-gradient-app { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #ec4899 100%); }
        select, input, textarea { font-size: 16px; }
    </style>
</head>
<body>
<div id="app" class="min-h-screen bg-gradient-app flex items-center justify-center">
    <div class="text-white text-center">
        <img src="https://i.postimg.cc/63h6w5x4/2026_02_18_12_20_55_slslegal_it.png" alt="SLS Studio Legale" class="w-64 h-64 mx-auto mb-4 object-contain animate-pulse">
        <p class="text-xl">Caricamento...</p>
    </div>
</div>

<script>
const SUPABASE_URL = 'https://vwfubfydakocuxhepwkq.supabase.co';
const SUPABASE_KEY = 'sb_publishable_ziNieyV1K_9bPBNJu6GHUQ_j2kVEyn2';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let state = {
    user: null,
    activeTab: 'dashboard',
    viewMode: 'cards',
    pratiche: [],
    praticheSemplici: [],
    avvocati: [],
    utenti: [],
    noteAggiornamento: [],
    searchTerm: '',
    filterStato: 'tutti',
    filterTipo: 'tutti',
    filterPriorita: 'tutti',
    filterAvvocato: 'tutti',
    showModal: false,
    showAvvocatoModal: false,
    showUtenteModal: false,
    showNoteModal: false,
    editingPratica: null,
    editingAvvocato: null,
    editingUtente: null,
    viewingPratica: null,
    successMessage: '',
    formData: { cliente:'', tipo_pratica:'civile', descrizione:'', stato:'svolgimento',
        data_apertura: today(), data_aggiornamento_attivita:'', timeline:'', scadenza:'',
        priorita:'media', rgnr:'', avvocato:'', nota_aggiornamento:'' },
    avvForm: { nome:'', cognome:'', email:'', telefono:'', specializzazione:'civile' },
    utenteForm: { username:'', password:'', nome_completo:'', email:'', ruolo:'avvocato' },
    noteForm: { nota:'' }
};

function today() { return new Date().toISOString().split('T')[0]; }
function isAdmin() { return state.user?.ruolo === 'amministratore'; }

function getInizialiAvvocato(n) {
    if (!n) return '';
    return n.split(' ').map(x => x[0]).join('.').toUpperCase();
}

function isPraticaScaduta(p) {
    if (!p.scadenza || p.stato !== 'svolgimento') return false;
    return new Date(p.scadenza) <= new Date();
}

async function loadAll() {
    await Promise.all([loadPratiche(), loadAvvocati(), isAdmin() ? loadUtenti() : Promise.resolve()]);
}

async function loadPratiche() {
    const { data, error } = await sb.from('pratiche').select('*').order('numero', { ascending: false });
    if (!error) state.pratiche = data || [];
}

async function loadAvvocati() {
    const { data, error } = await sb.from('avvocati').select('*').order('cognome');
    if (!error) state.avvocati = data || [];
}

async function loadUtenti() {
    const { data, error } = await sb.from('utenti').select('*').order('nome_completo');
    if (!error) state.utenti = data || [];
}

async function loadNote(praticaId) {
    const { data, error } = await sb.from('note_aggiornamento').select('*')
        .eq('pratica_id', praticaId).order('data_nota', { ascending: false });
    if (!error) state.noteAggiornamento = data || [];
}

function cleanPratica(p) {
    const c = {...p};
    ['data_aggiornamento_attivita','timeline','scadenza','data_modifica','nota_aggiornamento','rgnr'].forEach(k => {
        if (!c[k] || c[k] === '') c[k] = null;
    });
    return c;
}

async function savePratica(p) {
    try {
        const cl = cleanPratica(p);
        if (cl.id) {
            const { error } = await sb.from('pratiche').update(cl).eq('id', cl.id);
            if (error) throw error;
        } else {
            cl.numero = Date.now();
            cl.data_modifica = today();
            const { error } = await sb.from('pratiche').insert([cl]);
            if (error) throw error;
        }
        await loadPratiche();
        return true;
    } catch(e) { alert('Errore: ' + e.message); return false; }
}

async function aggiungiNota(praticaId, nota) {
    try {
        const { error } = await sb.from('note_aggiornamento').insert([{
            pratica_id: praticaId, data_nota: today(), nota,
            autore: state.user.nome_completo, autore_id: state.user.id
        }]);
        if (error) throw error;
        await loadNote(praticaId);
        return true;
    } catch(e) { alert('Errore: ' + e.message); return false; }
}

async function deletePratica(id) {
    if (!isAdmin()) { alert('Solo gli amministratori possono eliminare pratiche'); return; }
    const { error } = await sb.from('pratiche').delete().eq('id', id);
    if (!error) { await loadPratiche(); showSuccess('Pratica eliminata!'); render(); }
    else alert('Errore: ' + error.message);
}

async function saveAvvocato(avv) {
    try {
        avv.nome_completo = avv.nome + ' ' + avv.cognome;
        if (avv.id) {
            const { error } = await sb.from('avvocati').update(avv).eq('id', avv.id);
            if (error) throw error;
        } else {
            avv.data_creazione = today();
            const { error } = await sb.from('avvocati').insert([avv]);
            if (error) throw error;
        }
        await loadAvvocati();
        return true;
    } catch(e) { alert('Errore: ' + e.message); return false; }
}

async function deleteAvvocato(id) {
    const nome = state.avvocati.find(a => a.id === id)?.nome_completo;
    if (state.pratiche.filter(p => p.avvocato === nome).length > 0) {
        alert('Impossibile eliminare: ci sono pratiche assegnate!'); return;
    }
    const { error } = await sb.from('avvocati').delete().eq('id', id);
    if (!error) { await loadAvvocati(); showSuccess('Avvocato eliminato!'); render(); }
    else alert('Errore: ' + error.message);
}

async function saveUtente(u) {
    try {
        if (u.id) {
            const upd = {...u};
            if (!upd.password) delete upd.password;
            const { error } = await sb.from('utenti').update(upd).eq('id', u.id);
            if (error) throw error;
        } else {
            const { error } = await sb.from('utenti').insert([u]);
            if (error) throw error;
        }
        await loadUtenti();
        return true;
    } catch(e) { alert('Errore: ' + e.message); return false; }
}

async function deleteUtente(id) {
    if (id === state.user.id) { alert('Non puoi eliminare il tuo account!'); return; }
    const { error } = await sb.from('utenti').delete().eq('id', id);
    if (!error) { await loadUtenti(); showSuccess('Utente eliminato!'); render(); }
    else alert('Errore: ' + error.message);
}

async function login(username, password) {
    const { data, error } = await sb.from('utenti').select('*')
        .eq('username', username).eq('password', password).eq('attivo', true).single();
    if (error || !data) { alert('Username o password errati!'); return false; }
    state.user = data;
    await loadAll();
    const scadute = state.pratiche.filter(p => isPraticaScaduta(p));
    if (scadute.length > 0 && isAdmin()) {
        setTimeout(() => alert(`âš ï¸ ATTENZIONE: Ci sono ${scadute.length} pratica/e scaduta/e in svolgimento!`), 800);
    }
    render();
    return true;
}

function logout() { state.user = null; state.activeTab = 'dashboard'; render(); }

function esportaDati() {
    const data = { pratiche: state.pratiche, avvocati: state.avvocati, dataEsportazione: new Date().toISOString() };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `sls-backup-${today()}.json`;
    document.body.appendChild(a); a.click();
    document.body.removeChild(a); URL.revokeObjectURL(url);
    showSuccess('Dati esportati!');
}

function importaDati(e) {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = async (ev) => {
        try {
            const data = JSON.parse(ev.target.result);
            if (!confirm(`Importare ${data.pratiche?.length||0} pratiche e ${data.avvocati?.length||0} avvocati?`)) return;
            for (const a of (data.avvocati||[])) { delete a.id; delete a.created_at; await sb.from('avvocati').insert([a]); }
            for (const p of (data.pratiche||[])) { delete p.id; delete p.created_at; await sb.from('pratiche').insert([p]); }
            await loadAll();
            showSuccess(`Importati ${data.pratiche?.length||0} pratiche!`);
        } catch(er) { alert('Errore: ' + er.message); }
    };
    reader.readAsText(file); e.target.value = '';
}

function showSuccess(msg) {
    state.successMessage = msg; render();
    setTimeout(() => { state.successMessage = ''; render(); }, 3000);
}

function getStatoBadge(s) { return {svolgimento:'stato-svolgimento',fatto:'stato-fatto',bloccato:'stato-bloccato'}[s]||'stato-svolgimento'; }
function getStatoIcon(s) { return {fatto:'âœ…',bloccato:'ğŸš«'}[s]||'ğŸ”„'; }
function getPrioritaBadge(p) { return {bassa:'priorita-bassa',media:'priorita-media',alta:'priorita-alta'}[p]||'priorita-media'; }

function getAvvStats(nome) {
    const ps = state.pratiche.filter(p => p.avvocato === nome);
    return { totali:ps.length, svolgimento:ps.filter(p=>p.stato==='svolgimento').length,
        fatto:ps.filter(p=>p.stato==='fatto').length, bloccato:ps.filter(p=>p.stato==='bloccato').length };
}

function getFiltered() {
    return state.pratiche.filter(p => {
        const s = state.searchTerm.toLowerCase();
        const match = p.cliente.toLowerCase().includes(s) || p.descrizione.toLowerCase().includes(s) || (p.rgnr||'').toLowerCase().includes(s);
        return match &&
            (state.filterStato === 'tutti' || p.stato === state.filterStato) &&
            (state.filterTipo === 'tutti' || p.tipo_pratica === state.filterTipo) &&
            (state.filterPriorita === 'tutti' || p.priorita === state.filterPriorita) &&
            (state.filterAvvocato === 'tutti' || p.avvocato === state.filterAvvocato);
    });
}

function fmtDate(d) { return d ? new Date(d).toLocaleDateString('it-IT') : ''; }

function render() {
    if (!state.user) { renderLogin(); return; }
    const stats = {
        totali: state.pratiche.length,
        svolgimento: state.pratiche.filter(p=>p.stato==='svolgimento').length,
        fatto: state.pratiche.filter(p=>p.stato==='fatto').length,
        bloccato: state.pratiche.filter(p=>p.stato==='bloccato').length,
        scadute: state.pratiche.filter(p=>isPraticaScaduta(p)).length
    };
    const filtered = getFiltered();
    const tabs = [
        {id:'dashboard', label:'Dashboard', icon:'ğŸ“Š', show:true},
        {id:'pratiche', label:'Pratiche', icon:'ğŸ“', show:true},
        {id:'avvocati', label:'Avvocati', icon:'ğŸ‘¥', show:isAdmin()},
        {id:'utenti', label:'Utenti', icon:'ğŸ”', show:isAdmin()},
        {id:'gestione', label:'Gestione Dati', icon:'ğŸ—„ï¸', show:isAdmin()}
    ].filter(t=>t.show);

    document.getElementById('app').innerHTML = `
    <div class="max-w-7xl mx-auto p-4 w-full print-full">
        <div class="bg-white rounded-2xl shadow-2xl mb-6 overflow-hidden no-print">
            <div class="bg-gradient-indigo text-white p-6 relative">
                <div class="text-center">
                    <img src="https://i.postimg.cc/63h6w5x4/2026_02_18_12_20_55_slslegal_it.png" alt="Logo SLS" class="w-48 h-48 mx-auto mb-2 object-contain">
                    <h1 class="text-3xl font-bold mb-1">SLS Studio Legale</h1>
                    <p class="text-blue-200 text-sm mb-2">Sistema di Gestione Pratiche</p>
                    <div class="inline-flex items-center gap-2 bg-white bg-opacity-20 rounded-full px-4 py-1 text-sm">
                        <span>ğŸ‘¤ ${state.user.nome_completo}</span>
                        <span class="opacity-50">|</span>
                        <span>${state.user.ruolo==='amministratore'?'ğŸ‘‘ Admin':'âš–ï¸ Avvocato'}</span>
                    </div>
                </div>
                <button onclick="logout()" class="absolute top-4 right-4 px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg text-sm transition-all">
                    ğŸšª Esci
                </button>
            </div>
            <div class="flex bg-gray-50 border-b overflow-x-auto">
                ${tabs.map(t => `
                    <button onclick="switchTab('${t.id}')" class="flex items-center gap-2 px-5 py-4 font-semibold transition-all whitespace-nowrap text-sm
                        ${state.activeTab===t.id?'bg-white text-indigo-600 border-b-4 border-indigo-600':'text-gray-600 hover:bg-gray-100'}">
                        ${t.icon} ${t.label}
                    </button>
                `).join('')}
            </div>
        </div>

        ${state.successMessage ? `<div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-lg mb-4 no-print"><p class="font-semibold">âœ… ${state.successMessage}</p></div>` : ''}
        ${stats.scadute > 0 ? `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg mb-4 no-print animate-pulse"><p class="font-semibold">âš ï¸ ATTENZIONE: ${stats.scadute} pratica/e scaduta/e in svolgimento!</p></div>` : ''}

        ${state.activeTab==='dashboard' ? renderDashboard(stats) : ''}
        ${state.activeTab==='pratiche' ? renderPratiche(filtered) : ''}
        ${state.activeTab==='avvocati' ? renderAvvocati() : ''}
        ${state.activeTab==='utenti' ? renderUtenti() : ''}
        ${state.activeTab==='gestione' ? renderGestione() : ''}

        ${state.showModal ? renderModalPratica() : ''}
        ${state.showAvvocatoModal ? renderModalAvvocato() : ''}
        ${state.showUtenteModal ? renderModalUtente() : ''}
        ${state.showNoteModal ? renderModalNote() : ''}
    </div>`;
}

function renderLogin() {
    document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-gradient-app flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <img src="https://i.postimg.cc/63h6w5x4/2026_02_18_12_20_55_slslegal_it.png" alt="SLS Studio Legale" class="w-64 h-64 mx-auto mb-4 object-contain">
                <h1 class="text-3xl font-bold text-gray-800 mb-1">SLS Studio Legale</h1>
                <p class="text-gray-500">Sistema di Gestione Pratiche</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Username</label>
                    <input type="text" id="loginUsername" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none" placeholder="Il tuo username"/>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Password</label>
                    <input type="password" id="loginPassword" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none" placeholder="La tua password" onkeypress="if(event.key==='Enter')doLogin()"/>
                </div>
                <button onclick="doLogin()" class="w-full px-6 py-3 bg-gradient-purple text-white rounded-lg font-semibold hover:shadow-lg transition-all">
                    ğŸ” Accedi
                </button>
            </div>
            <p class="mt-6 text-center text-xs text-gray-400">ğŸ‘¤ Admin: <strong>admin</strong> / <strong>admin123</strong></p>
        </div>
    </div>`;
}

function renderDashboard(stats) {
    return `<div class="grid grid-cols-2 gap-4 md:grid-cols-4">
        ${[
            {label:'Totale Pratiche',val:stats.totali,icon:'ğŸ“',color:'indigo'},
            {label:'In Svolgimento',val:stats.svolgimento,icon:'ğŸ”„',color:'yellow'},
            {label:'Fatto',val:stats.fatto,icon:'âœ…',color:'green'},
            {label:'Bloccato',val:stats.bloccato,icon:'ğŸš«',color:'red'}
        ].map(s=>`
            <div class="bg-white rounded-xl p-6 shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">${s.label}</p>
                        <p class="text-3xl font-bold text-${s.color}-600">${s.val}</p>
                    </div>
                    <span class="text-4xl">${s.icon}</span>
                </div>
            </div>`).join('')}
    </div>`;
}

function renderPratiche(filtered) {
    const tipi = ['tutti','civile','penale','amministrativo','lavoro','famiglia','tributario','tribunale','cgt','tribunale_cgt1','tribunale_cgt2','cassazione','mediazione'];
    const avvs = ['tutti', ...new Set(state.pratiche.map(p=>p.avvocato).filter(Boolean))];
    return `
    <div class="space-y-4">
        <div class="bg-white rounded-xl shadow-lg p-4 no-print">
            <div class="flex flex-col gap-3">
                <div class="flex gap-3">
                    <div class="flex-1 relative">
                        <span class="absolute left-3 top-3 text-gray-400">ğŸ”</span>
                        <input type="text" placeholder="Cerca cliente, descrizione, RGNR..." value="${state.searchTerm}"
                            oninput="state.searchTerm=this.value;render()"
                            class="w-full pl-10 pr-4 py-2 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none"/>
                    </div>
                    <button onclick="state.viewMode='cards';render()" class="px-3 py-2 ${state.viewMode==='cards'?'bg-indigo-600 text-white':'bg-gray-200'} rounded-lg">ğŸ“‹</button>
                    <button onclick="state.viewMode='table';render()" class="px-3 py-2 ${state.viewMode==='table'?'bg-indigo-600 text-white':'bg-gray-200'} rounded-lg">ğŸ“Š</button>
                    ${isAdmin()?`<button onclick="openPraticaModal(null)" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold whitespace-nowrap">â• Nuova</button>`:''}
                </div>
                <div class="grid grid-cols-2 gap-2 md:grid-cols-5">
                    <select onchange="state.filterStato=this.value;render()" class="px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none text-sm">
                        <option value="tutti" ${state.filterStato==='tutti'?'selected':''}>Tutti stati</option>
                        <option value="svolgimento" ${state.filterStato==='svolgimento'?'selected':''}>Svolgimento</option>
                        <option value="fatto" ${state.filterStato==='fatto'?'selected':''}>Fatto</option>
                        <option value="bloccato" ${state.filterStato==='bloccato'?'selected':''}>Bloccato</option>
                    </select>
                    <select onchange="state.filterTipo=this.value;render()" class="px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none text-sm">
                        ${tipi.map(t=>`<option value="${t}" ${state.filterTipo===t?'selected':''}>${t==='tutti'?'Tutti tipi':t.replace('_',' ')}</option>`).join('')}
                    </select>
                    <select onchange="state.filterPriorita=this.value;render()" class="px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none text-sm">
                        <option value="tutti">Tutte prioritÃ </option>
                        <option value="bassa" ${state.filterPriorita==='bassa'?'selected':''}>Bassa</option>
                        <option value="media" ${state.filterPriorita==='media'?'selected':''}>Media</option>
                        <option value="alta" ${state.filterPriorita==='alta'?'selected':''}>Alta</option>
                    </select>
                    <select onchange="state.filterAvvocato=this.value;render()" class="px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none text-sm">
                        ${avvs.map(a=>`<option value="${a}" ${state.filterAvvocato===a?'selected':''}>${a==='tutti'?'Tutti avvocati':getInizialiAvvocato(a)}</option>`).join('')}
                    </select>
                    <button onclick="window.print()" class="px-4 py-2 bg-gray-600 text-white rounded-lg text-sm">ğŸ–¨ï¸ Stampa</button>
                </div>
            </div>
        </div>
        ${state.viewMode==='table' ? renderPraticheTable(filtered) : renderPraticheCards(filtered)}
    </div>`;
}

function renderPraticheCards(filtered) {
    if (!filtered.length) return `<div class="bg-white rounded-xl shadow-lg p-12 text-center"><div class="text-6xl mb-4">ğŸ“</div><p class="text-gray-400 text-lg">Nessuna pratica trovata</p></div>`;
    return `<div class="space-y-3">
        ${filtered.map(p => {
            const sc = isPraticaScaduta(p);
            return `<div class="bg-white rounded-xl shadow-lg p-5 ${sc?'scaduta':''}">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
                    <div class="flex-1">
                        <div class="flex flex-wrap gap-2 mb-2">
                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${getStatoBadge(p.stato)}">${getStatoIcon(p.stato)} ${p.stato.toUpperCase()}</span>
                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${getPrioritaBadge(p.priorita)}">${p.priorita.toUpperCase()}</span>
                            <span class="px-2 py-1 bg-gray-100 rounded-full text-xs">${p.tipo_pratica}</span>
                            ${p.rgnr?`<span class="px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs">RGNR: ${p.rgnr}</span>`:''}
                        </div>
                        <h3 class="text-lg font-bold text-gray-800">${p.cliente}</h3>
                        <p class="text-gray-600 text-sm mb-2">${p.descrizione}</p>
                        <div class="flex flex-wrap gap-3 text-xs text-gray-500">
                            <span>ğŸ‘¤ ${getInizialiAvvocato(p.avvocato)}</span>
                            <span>ğŸ“… ${fmtDate(p.data_apertura)}</span>
                            ${p.scadenza?`<span class="${sc?'text-red-600 font-bold':''}">â° ${fmtDate(p.scadenza)}</span>`:''}
                            ${p.timeline?`<span>ğŸ“ ${fmtDate(p.timeline)}</span>`:''}
                            ${p.data_aggiornamento_attivita?`<span>ğŸ”„ ${fmtDate(p.data_aggiornamento_attivita)}</span>`:''}
                        </div>
                    </div>
                    <div class="flex gap-2 no-print">
                        <button onclick="viewPratica('${p.id}')" class="px-3 py-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600">ğŸ‘ï¸ Vedi</button>
                        ${isAdmin()?`
                        <button onclick="openPraticaModal(${JSON.stringify(p).replace(/"/g,'&quot;')})" class="px-3 py-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600">âœï¸</button>
                        <button onclick="if(confirm('Eliminare?'))deletePratica('${p.id}')" class="px-3 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600">ğŸ—‘ï¸</button>
                        `:`<button onclick="openNoteModal('${p.id}')" class="px-3 py-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600">ğŸ“ Nota</button>`}
                    </div>
                </div>
            </div>`;
        }).join('')}
    </div>`;
}

function renderPraticheTable(filtered) {
    return `<div class="bg-white rounded-xl shadow-lg overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="bg-gray-100">
                <tr>${['Cliente','Tipo','Stato','PrioritÃ ','Scadenza','Timeline','Avv.','Agg.','Azioni'].map(h=>`<th class="px-3 py-3 text-left font-semibold">${h}</th>`).join('')}</tr>
            </thead>
            <tbody>
                ${filtered.map(p=>{
                    const sc=isPraticaScaduta(p);
                    return `<tr class="border-b hover:bg-gray-50 ${sc?'bg-red-50':''}">
                        <td class="px-3 py-3"><div class="font-semibold">${p.cliente}</div><div class="text-xs text-gray-400">${p.descrizione.substring(0,40)}...</div></td>
                        <td class="px-3 py-2">${p.tipo_pratica}</td>
                        <td class="px-3 py-2"><span class="px-2 py-1 rounded text-xs font-semibold ${getStatoBadge(p.stato)}">${p.stato}</span></td>
                        <td class="px-3 py-2"><span class="px-2 py-1 rounded text-xs font-semibold ${getPrioritaBadge(p.priorita)}">${p.priorita}</span></td>
                        <td class="px-3 py-2 ${sc?'text-red-600 font-bold':''}">${fmtDate(p.scadenza)||'-'}</td>
                        <td class="px-3 py-2">${fmtDate(p.timeline)||'-'}</td>
                        <td class="px-3 py-2 font-semibold">${getInizialiAvvocato(p.avvocato)}</td>
                        <td class="px-3 py-2">${fmtDate(p.data_aggiornamento_attivita)||'-'}</td>
                        <td class="px-3 py-2 no-print">
                            <div class="flex gap-1">
                                <button onclick="viewPratica('${p.id}')" class="px-2 py-1 bg-green-500 text-white rounded text-xs">ğŸ‘ï¸</button>
                                ${isAdmin()?`<button onclick="openPraticaModal(${JSON.stringify(p).replace(/"/g,'&quot;')})" class="px-2 py-1 bg-blue-500 text-white rounded text-xs">âœï¸</button>`:`<button onclick="openNoteModal('${p.id}')" class="px-2 py-1 bg-blue-500 text-white rounded text-xs">ğŸ“</button>`}
                            </div>
                        </td>
                    </tr>`;
                }).join('')}
            </tbody>
        </table>
    </div>`;
}

function renderAvvocati() {
    return `<div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">ğŸ‘¥ Archivio Avvocati</h2>
            <div class="flex gap-2">
                <button onclick="window.print()" class="px-4 py-2 bg-gray-600 text-white rounded-lg no-print">ğŸ–¨ï¸ Stampa</button>
                <button onclick="openAvvocatoModal(null)" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold no-print">â• Nuovo</button>
            </div>
        </div>
        ${state.avvocati.length?`<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            ${state.avvocati.map(a=>{
                const st=getAvvStats(a.nome_completo);
                return `<div class="bg-indigo-50 rounded-xl p-5 border-2 border-indigo-100">
                    <div class="flex justify-between mb-3">
                        <div><h3 class="text-lg font-bold text-gray-800">${a.nome_completo}</h3><p class="text-sm text-indigo-600">${a.specializzazione}</p></div>
                        <span class="text-3xl">ğŸ’¼</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-1">ğŸ“§ ${a.email}</p>
                    <p class="text-sm text-gray-600 mb-3">ğŸ“± ${a.telefono}</p>
                    <div class="bg-white rounded-lg p-3 mb-3 grid grid-cols-4 gap-2 text-center">
                        <div><p class="text-lg font-bold">${st.totali}</p><p class="text-xs text-gray-400">Totali</p></div>
                        <div><p class="text-lg font-bold text-yellow-600">${st.svolgimento}</p><p class="text-xs text-gray-400">Svolgimento</p></div>
                        <div><p class="text-lg font-bold text-green-600">${st.fatto}</p><p class="text-xs text-gray-400">Fatto</p></div>
                        <div><p class="text-lg font-bold text-red-600">${st.bloccato}</p><p class="text-xs text-gray-400">Bloccato</p></div>
                    </div>
                    <div class="flex gap-2 no-print">
                        <button onclick="openAvvocatoModal(${JSON.stringify(a).replace(/"/g,'&quot;')})" class="flex-1 px-3 py-2 bg-blue-500 text-white rounded-lg text-sm">âœï¸ Modifica</button>
                        <button onclick="if(confirm('Eliminare?'))deleteAvvocato('${a.id}')" class="flex-1 px-3 py-2 bg-red-500 text-white rounded-lg text-sm">ğŸ—‘ï¸ Elimina</button>
                    </div>
                </div>`;
            }).join('')}
        </div>`:`<div class="text-center py-12"><div class="text-6xl mb-4">ğŸ‘¥</div><p class="text-gray-400">Nessun avvocato in archivio</p></div>`}
    </div>`;
}

function renderUtenti() {
    return `<div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">ğŸ” Gestione Utenti</h2>
            <button onclick="openUtenteModal(null)" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold">â• Nuovo Utente</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            ${state.utenti.map(u=>`<div class="bg-blue-50 rounded-xl p-5 border-2 border-blue-100">
                <div class="flex justify-between mb-3">
                    <div><h3 class="text-lg font-bold text-gray-800">${u.nome_completo}</h3>
                    <p class="text-sm ${u.ruolo==='amministratore'?'text-red-600':'text-indigo-600'} font-semibold">${u.ruolo==='amministratore'?'ğŸ‘‘ Amministratore':'âš–ï¸ Avvocato'}</p></div>
                    <span class="text-3xl">${u.ruolo==='amministratore'?'ğŸ‘‘':'ğŸ‘¤'}</span>
                </div>
                <p class="text-sm text-gray-600 mb-1">ğŸ”‘ <strong>${u.username}</strong></p>
                <p class="text-sm text-gray-600 mb-1">ğŸ“§ ${u.email}</p>
                <p class="text-sm mb-3 ${u.attivo?'text-green-600':'text-red-600'}">${u.attivo?'âœ… Attivo':'âŒ Disattivato'}</p>
                <div class="flex gap-2">
                    <button onclick="openUtenteModal(${JSON.stringify(u).replace(/"/g,'&quot;')})" class="flex-1 px-3 py-2 bg-blue-500 text-white rounded-lg text-sm">âœï¸ Modifica</button>
                    <button onclick="if(confirm('Eliminare?'))deleteUtente('${u.id}')" class="flex-1 px-3 py-2 bg-red-500 text-white rounded-lg text-sm">ğŸ—‘ï¸ Elimina</button>
                </div>
            </div>`).join('')}
        </div>
    </div>`;
}

function renderGestione() {
    return `<div class="bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">ğŸ—„ï¸ Gestione Database</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-green-50 rounded-xl p-6 border-2 border-green-200">
                <h3 class="text-xl font-bold mb-2">ğŸ“¥ Esporta Dati</h3>
                <p class="text-sm text-gray-600 mb-4">Pratiche: <strong>${state.pratiche.length}</strong> | Avvocati: <strong>${state.avvocati.length}</strong></p>
                <button onclick="esportaDati()" class="w-full px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700">ğŸ“¥ Esporta Backup</button>
            </div>
            <div class="bg-blue-50 rounded-xl p-6 border-2 border-blue-200">
                <h3 class="text-xl font-bold mb-2">ğŸ“¤ Importa Dati</h3>
                <p class="text-sm text-gray-600 mb-4">âš ï¸ I dati verranno aggiunti al database esistente.</p>
                <label class="w-full px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 flex items-center justify-center gap-2 cursor-pointer">
                    ğŸ“¤ Seleziona Backup JSON
                    <input type="file" accept=".json" onchange="importaDati(event)" class="hidden"/>
                </label>
            </div>
        </div>
    </div>`;
}

function renderModalPratica() {
    const tipi = ['civile','penale','amministrativo','lavoro','famiglia','tributario','tribunale','cgt','tribunale_cgt1','tribunale_cgt2','cassazione','mediazione'];
    return `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full my-4">
            <div class="bg-gradient-indigo text-white p-5 flex justify-between items-center rounded-t-2xl">
                <h2 class="text-xl font-bold">${state.editingPratica?'âœï¸ Modifica Pratica':'â• Nuova Pratica'}</h2>
                <button onclick="state.showModal=false;render()" class="text-2xl hover:opacity-70">âœ•</button>
            </div>
            <div class="p-5 space-y-3 max-h-screen overflow-y-auto">
                <div><label class="block text-sm font-semibold text-gray-700 mb-1">Cliente *</label>
                    <input type="text" value="${state.formData.cliente}" oninput="state.formData.cliente=this.value" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none"/></div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-sm font-semibold text-gray-700 mb-1">Tipo *</label>
                        <select onchange="state.formData.tipo_pratica=this.value" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none">
                            ${tipi.map(t=>`<option value="${t}" ${state.formData.tipo_pratica===t?'selected':''}>${t.replace('_',' ')}</option>`).join('')}
                        </select></div>
                    <div><label class="block text-sm font-semibold text-gray-700 mb-1">RGNR</label>
                        <input type="text" value="${state.formData.rgnr||''}" oninput="state.formData.rgnr=this.value" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none"/></div>
                </div>
                <div><label class="block text-sm font-semibold text-gray-700 mb-1">Descrizione *</label>
                    <textarea oninput="state.formData.descrizione=this.value" rows="3" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none">${state.formData.descrizione}</textarea></div>
                <div class="grid grid-cols-3 gap-3">
                    <div><label class="block text-sm font-semibold text-gray-700 mb-1">Stato *</label>
                        <select onchange="state.formData.stato=this.value" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none">
                            ${[['svolgimento','Svolgimento'],['fatto','Fatto'],['bloccato','Bloccato']].map(([v,l])=>`<option value="${v}" ${state.formData.stato===v?'selected':''}>${l}</option>`).join('')}
                        </select></div>
                    <div><label class="block text-sm font-semibold text-gray-700 mb-1">PrioritÃ  *</label>
                        <select onchange="state.formData.priorita=this.value" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none">
                            ${[['bassa','Bassa'],['media','Media'],['alta','Alta']].map(([v,l])=>`<option value="${v}" ${state.formData.priorita===v?'selected':''}>${l}</option>`).join('')}
                        </select></div>
                    <div><label class="block text-sm font-semibold text-gray-700 mb-1">Apertura *</label>
                        <input type="date" value="${state.formData.data_apertura}" oninput="state.formData.data_apertura=this.value" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none"/></div>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div><label class="block text-sm font-semibold text-gray-700 mb-1">Scadenza</label>
                        <input type="date" value="${state.formData.scadenza||''}" oninput="state.formData.scadenza=this.value" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none"/></div>
                    <div><label class="block text-sm font-semibold text-gray-700 mb-1">Timeline</label>
                        <input type="date" value="${state.formData.timeline||''}" oninput="state.formData.timeline=this.value" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none"/></div>
                    <div><label class="block text-sm font-semibold text-gray-700 mb-1">Agg.AttivitÃ </label>
                        <input type="date" value="${state.formData.data_aggiornamento_attivita||''}" oninput="state.formData.data_aggiornamento_attivita=this.value" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none"/></div>
                </div>
                <div><label class="block text-sm font-semibold text-gray-700 mb-1">Avvocato *</label>
                    <select onchange="state.formData.avvocato=this.value" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none">
                        <option value="">-- Seleziona --</option>
                        ${state.avvocati.map(a=>`<option value="${a.nome_completo}" ${state.formData.avvocato===a.nome_completo?'selected':''}>${a.nome_completo}</option>`).join('')}
                    </select></div>
                <div><label class="block text-sm font-semibold text-gray-700 mb-1">Nota Aggiornamento</label>
                    <textarea oninput="state.formData.nota_aggiornamento=this.value" rows="2" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none">${state.formData.nota_aggiornamento||''}</textarea></div>
                <div class="flex gap-3 pt-2">
                    <button onclick="submitPratica()" class="flex-1 px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700">ğŸ’¾ ${state.editingPratica?'Aggiorna':'Salva'}</button>
                    <button onclick="state.showModal=false;render()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold">Annulla</button>
                </div>
            </div>
        </div>
    </div>`;
}

function renderModalAvvocato() {
    return `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full">
            <div class="bg-gradient-indigo text-white p-5 flex justify-between items-center rounded-t-2xl">
                <h2 class="text-xl font-bold">${state.editingAvvocato?'âœï¸ Modifica Avvocato':'â• Nuovo Avvocato'}</h2>
                <button onclick="state.showAvvocatoModal=false;render()" class="text-2xl hover:opacity-70">âœ•</button>
            </div>
            <div class="p-5 space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-sm font-semibold mb-1">Nome *</label>
                        <input type="text" value="${state.avvForm.nome}" oninput="state.avvForm.nome=this.value" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none"/></div>
                    <div><label class="block text-sm font-semibold mb-1">Cognome *</label>
                        <input type="text" value="${state.avvForm.cognome}" oninput="state.avvForm.cognome=this.value" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none"/></div>
                </div>
                <div><label class="block text-sm font-semibold mb-1">Email *</label>
                    <input type="email" value="${state.avvForm.email}" oninput="state.avvForm.email=this.value" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none"/></div>
                <div><label class="block text-sm font-semibold mb-1">Telefono *</label>
                    <input type="tel" value="${state.avvForm.telefono}" oninput="state.avvForm.telefono=this.value" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none"/></div>
                <div><label class="block text-sm font-semibold mb-1">Specializzazione</label>
                    <select onchange="state.avvForm.specializzazione=this.value" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none">
                        ${['civile','penale','amministrativo','lavoro','famiglia','tributario'].map(s=>`<option value="${s}" ${state.avvForm.specializzazione===s?'selected':''}>${s}</option>`).join('')}
                    </select></div>
                <div class="flex gap-3 pt-2">
                    <button onclick="submitAvvocato()" class="flex-1 px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold">ğŸ’¾ ${state.editingAvvocato?'Aggiorna':'Salva'}</button>
                    <button onclick="state.showAvvocatoModal=false;render()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg">Annulla</button>
                </div>
            </div>
        </div>
    </div>`;
}

function renderModalUtente() {
    return `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full">
            <div class="bg-gradient-indigo text-white p-5 flex justify-between items-center rounded-t-2xl">
                <h2 class="text-xl font-bold">${state.editingUtente?'âœï¸ Modifica Utente':'â• Nuovo Utente'}</h2>
                <button onclick="state.showUtenteModal=false;render()" class="text-2xl hover:opacity-70">âœ•</button>
            </div>
            <div class="p-5 space-y-3">
                <div><label class="block text-sm font-semibold mb-1">Username *</label>
                    <input type="text" value="${state.utenteForm.username}" ${state.editingUtente?'disabled':''} oninput="state.utenteForm.username=this.value" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none ${state.editingUtente?'bg-gray-100':''}"/></div>
                <div><label class="block text-sm font-semibold mb-1">Password ${state.editingUtente?'(vuoto = non cambiare)':'*'}</label>
                    <input type="password" value="" oninput="state.utenteForm.password=this.value" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none"/></div>
                <div><label class="block text-sm font-semibold mb-1">Nome Completo *</label>
                    <input type="text" value="${state.utenteForm.nome_completo}" oninput="state.utenteForm.nome_completo=this.value" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none"/></div>
                <div><label class="block text-sm font-semibold mb-1">Email *</label>
                    <input type="email" value="${state.utenteForm.email}" oninput="state.utenteForm.email=this.value" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none"/></div>
                <div><label class="block text-sm font-semibold mb-1">Ruolo *</label>
                    <select onchange="state.utenteForm.ruolo=this.value" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none">
                        <option value="avvocato" ${state.utenteForm.ruolo==='avvocato'?'selected':''}>âš–ï¸ Avvocato</option>
                        <option value="amministratore" ${state.utenteForm.ruolo==='amministratore'?'selected':''}>ğŸ‘‘ Amministratore</option>
                    </select></div>
                <div class="flex gap-3 pt-2">
                    <button onclick="submitUtente()" class="flex-1 px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold">ğŸ’¾ ${state.editingUtente?'Aggiorna':'Crea'}</button>
                    <button onclick="state.showUtenteModal=false;render()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg">Annulla</button>
                </div>
            </div>
        </div>
    </div>`;
}

function renderModalNote() {
    const p = state.viewingPratica;
    return `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-screen overflow-y-auto">
            <div class="bg-gradient-indigo text-white p-5 relative rounded-t-2xl">
                <h2 class="text-lg font-bold">${p?.cliente}</h2>
                <p class="text-sm opacity-75">${p?.descrizione}</p>
                <button onclick="state.showNoteModal=false;render()" class="absolute top-4 right-4 text-2xl hover:opacity-70">âœ•</button>
            </div>
            <div class="p-5">
                ${!isAdmin()?`<div class="mb-5">
                    <label class="block text-sm font-semibold mb-1">Aggiungi Nota</label>
                    <textarea oninput="state.noteForm.nota=this.value" rows="3" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none mb-2" placeholder="Scrivi qui la nota...">${state.noteForm.nota||''}</textarea>
                    <button onclick="submitNota()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-semibold">â• Aggiungi</button>
                </div>`:''}
                <h3 class="text-lg font-bold text-gray-800 mb-3">ğŸ“œ Storico Note</h3>
                ${state.noteAggiornamento.length?`<div class="space-y-3">
                    ${state.noteAggiornamento.map(n=>`<div class="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                        <div class="flex justify-between text-sm text-gray-500 mb-1">
                            <span>ğŸ‘¤ <strong>${n.autore}</strong></span>
                            <span>ğŸ“… ${fmtDate(n.data_nota)}</span>
                        </div>
                        <p class="text-gray-800">${n.nota}</p>
                    </div>`).join('')}
                </div>`:`<p class="text-gray-400 text-center py-8">Nessuna nota ancora inserita</p>`}
            </div>
        </div>
    </div>`;
}

function switchTab(tab) { state.activeTab = tab; render(); }

async function doLogin() {
    const u = document.getElementById('loginUsername')?.value;
    const p = document.getElementById('loginPassword')?.value;
    if (!u || !p) { alert('Inserisci username e password'); return; }
    await login(u, p);
}

function openPraticaModal(p) {
    state.editingPratica = p;
    state.formData = p ? {...p} : { cliente:'', tipo_pratica:'civile', descrizione:'', stato:'svolgimento',
        data_apertura:today(), data_aggiornamento_attivita:'', timeline:'', scadenza:'',
        priorita:'media', rgnr:'', avvocato:'', nota_aggiornamento:'' };
    state.showModal = true; render();
}

function openAvvocatoModal(a) {
    state.editingAvvocato = a;
    state.avvForm = a ? {nome:a.nome,cognome:a.cognome,email:a.email,telefono:a.telefono,specializzazione:a.specializzazione}
        : {nome:'',cognome:'',email:'',telefono:'',specializzazione:'civile'};
    state.showAvvocatoModal = true; render();
}

function openUtenteModal(u) {
    state.editingUtente = u;
    state.utenteForm = u ? {username:u.username,password:'',nome_completo:u.nome_completo,email:u.email,ruolo:u.ruolo}
        : {username:'',password:'',nome_completo:'',email:'',ruolo:'avvocato'};
    state.showUtenteModal = true; render();
}

async function openNoteModal(praticaId) {
    state.viewingPratica = state.pratiche.find(pr=>pr.id===praticaId);
    state.noteForm = {nota:''};
    await loadNote(praticaId);
    state.showNoteModal = true; render();
}

async function viewPratica(praticaId) { await openNoteModal(praticaId); }

async function submitPratica() {
    if (!state.formData.cliente || !state.formData.descrizione || !state.formData.avvocato) {
        alert('Compila tutti i campi obbligatori (*)'); return;
    }
    const p = {...state.formData};
    if (state.editingPratica) p.id = state.editingPratica.id;
    p.data_modifica = today();
    const ok = await savePratica(p);
    if (ok) { state.showModal = false; state.editingPratica = null; showSuccess('Pratica salvata!'); render(); }
}

async function submitAvvocato() {
    if (!state.avvForm.nome || !state.avvForm.cognome || !state.avvForm.email || !state.avvForm.telefono) {
        alert('Compila tutti i campi (*)'); return;
    }
    const a = {...state.avvForm};
    if (state.editingAvvocato) a.id = state.editingAvvocato.id;
    const ok = await saveAvvocato(a);
    if (ok) { state.showAvvocatoModal = false; state.editingAvvocato = null; showSuccess('Avvocato salvato!'); render(); }
}

async function submitUtente() {
    if (!state.utenteForm.username || !state.utenteForm.nome_completo || !state.utenteForm.email) {
        alert('Compila tutti i campi (*)'); return;
    }
    if (!state.editingUtente && !state.utenteForm.password) { alert('Inserisci una password'); return; }
    const u = {...state.utenteForm};
    if (state.editingUtente) u.id = state.editingUtente.id;
    u.attivo = true;
    const ok = await saveUtente(u);
    if (ok) { state.showUtenteModal = false; state.editingUtente = null; showSuccess('Utente salvato!'); render(); }
}

async function submitNota() {
    if (!state.noteForm.nota) { alert('Scrivi una nota!'); return; }
    const ok = await aggiungiNota(state.viewingPratica.id, state.noteForm.nota);
    if (ok) { state.noteForm = {nota:''}; showSuccess('Nota aggiunta!'); render(); }
}

render();
</script>
</body>
</html>






